name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9:00 AM
    - cron: '0 9 * * 1'

jobs:
  security-audit:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety
    
    - name: Run Bandit (Security Linter)
      run: |
        bandit -r backend/ frontend/ -f json -o bandit-report.json --exit-zero || true
        bandit -r backend/ frontend/ -f txt --exit-zero || true
      continue-on-error: true
    
    - name: Check for PowerShell execution
      run: |
        echo "Checking for PowerShell execution..."
        python -c "import os; import sys; found = False; [print(f'WARNING: PowerShell execution found in {root}/{file}:{i}') or setattr(sys.modules[__name__], 'found', True) for root, dirs, files in os.walk('.') for file in files if file.endswith('.py') and 'test' not in root and 'scripts' not in root and 'verify' not in file for i, line in enumerate(open(os.path.join(root, file), encoding='utf-8', errors='ignore'), 1) if not line.strip().startswith('#') and ('subprocess' in line and 'powershell' in line.lower() or 'Popen' in line and 'powershell' in line.lower() or '.run(' in line and 'powershell' in line.lower())]; sys.exit(1 if found else 0)"
    
    - name: Check for eval/exec usage
      run: |
        echo "Checking for eval/exec usage..."
        python -c "import os; import sys; found = False; [print(f'WARNING: eval/exec found in {root}/{file}') or setattr(sys.modules[__name__], 'found', True) for root, dirs, files in os.walk('.') for file in files if file.endswith('.py') for line in open(os.path.join(root, file), encoding='utf-8', errors='ignore') if 'eval(' in line or 'exec(' in line]; sys.exit(1 if found else 0)"
    
    - name: Run Security Tests
      run: |
        python tests/test_all_security.py
    
    - name: Run Unit Tests
      run: |
        python tests/test_coverage_complete.py
    
    - name: Upload Bandit Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
